# Grafana Dashboard 使用指南

## 📊 Dashboard 概览

余额监控 Dashboard 提供了全面的项目余额、订阅续费和系统状态可视化。

### 面板布局

```
┌─────────────────────────────────────────────────────────────┐
│  概览指标（6个）                                             │
│  [项目总数] [正常数] [告警数] [订阅总数] [即将到期] [最后检查]│
├─────────────────────────────────────────────────────────────┤
│  项目余额对比（柱状图）    │  余额比例（仪表盘）              │
├─────────────────────────────────────────────────────────────┤
│  余额趋势图（时间序列）                                      │
├─────────────────────────────────────────────────────────────┤
│  项目余额详情表（可排序、可筛选）                             │
├─────────────────────────────────────────────────────────────┤
│  订阅续费倒计时           │  订阅状态详情表                  │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 核心功能

### 1. 概览指标卡片

**顶部 6 个关键指标**：
- **监控项目总数**：当前监控的项目数量
- **正常项目数**：余额充足的项目（绿色）
- **告警项目数**：余额不足的项目（红色）
- **订阅总数**：配置的订阅数量
- **7天内到期订阅**：即将到期的订阅数
- **最后检查时间**：系统最后一次检查的时间

### 2. 项目余额对比

**柱状图显示**：
- 横向对比所有项目的余额
- 颜色区分不同服务商
- 图例显示：last, min, max 值

### 3. 余额比例仪表盘

**仪表盘显示**：
- 余额/阈值比例（0-100%）
- 颜色编码：
  - 🔴 红色：< 20%（危险）
  - 🟡 黄色：20-50%（警告）
  - 🟢 绿色：> 50%（正常）
- 横向布局，一目了然

### 4. 余额趋势图

**时间序列图表**：
- Smooth 平滑曲线
- 渐变填充效果
- 图例统计：last, min, max, mean
- 支持交互缩放和时间范围选择

### 5. 项目余额详情表

**表格功能**：
- **列**：项目名、服务商、类型、余额、阈值、余额比例、状态
- **排序**：点击列头排序
- **颜色编码**：
  - 余额：红 → 黄 → 绿
  - 余额比例：仪表盘显示
  - 状态：✅ 正常 / ❌ 告警
- **筛选**：通过顶部变量筛选项目

### 6. 订阅续费倒计时

**横向卡片显示**：
- 显示每个订阅距离续费的天数
- 颜色编码：
  - 🔴 红色：< 3 天
  - 🟡 黄色：3-7 天
  - 🟢 绿色：> 7 天
- 自动排序（从近到远）

### 7. 订阅状态详情表

**表格功能**：
- **列**：订阅名称、周期、剩余天数、货币、续费金额、状态
- **状态显示**：
  - 🟢 正常
  - 🔴 需续费
  - 🔵 已续费
- **排序**：默认按剩余天数排序

## 🎨 交互功能

### 变量筛选器

Dashboard 顶部提供两个筛选器：

1. **项目筛选器** (`project`)
   - 支持多选
   - 默认显示所有项目
   - 动态加载项目列表

2. **订阅筛选器** (`subscription`)
   - 支持多选
   - 默认显示所有订阅
   - 动态加载订阅列表

**使用方法**：
```
1. 点击顶部变量下拉框
2. 选择要查看的项目/订阅
3. 所有面板自动更新
4. 点击 "All" 查看全部
```

### 时间范围选择

**默认时间范围**：最近 6 小时

**修改方法**：
1. 点击右上角时间选择器
2. 选择预设范围（1h, 3h, 6h, 12h, 24h, 7d, 30d）
3. 或自定义时间范围

### 自动刷新

**默认刷新间隔**：1 分钟

**修改方法**：
1. 点击右上角刷新间隔下拉框
2. 选择刷新频率（5s, 10s, 30s, 1m, 5m, 15m, 30m, 1h）
3. 或关闭自动刷新

## 📈 告警阈值配置

### 余额比例阈值

```
🔴 危险：< 20%（余额严重不足）
🟡 警告：20% - 50%（余额偏低）
🟢 正常：> 50%（余额充足）
```

### 订阅续费阈值

```
🔴 紧急：剩余 < 3 天
🟡 提醒：剩余 3-7 天
🟢 正常：剩余 > 7 天
```

### 余额数值阈值（示例）

```
🔴 低：< 1,000
🟡 中：1,000 - 10,000
🟢 高：> 10,000
```

**注意**：实际阈值根据项目配置自动调整

## 🔍 PromQL 查询示例

### 常用查询

**查看特定项目余额**：
```promql
balance_alert_balance{project="OpenRouter"}
```

**查看余额不足的项目**：
```promql
balance_alert_balance{balance_alert_status="0"}
```

**计算平均余额比例**：
```promql
avg(balance_alert_ratio)
```

**查询7天内到期的订阅**：
```promql
balance_alert_subscription_days <= 7
```

**统计告警项目数**：
```promql
count(balance_alert_status == 0)
```

## 🎯 最佳实践

### 1. 日常监控

**推荐配置**：
- 时间范围：6 小时或 24 小时
- 自动刷新：1-5 分钟
- 关注面板：概览指标 + 余额详情表

### 2. 趋势分析

**推荐配置**：
- 时间范围：7 天或 30 天
- 面板：余额趋势图
- 查看 min/max/mean 统计

### 3. 告警处理

**步骤**：
1. 查看"告警项目数"指标
2. 在"项目余额详情表"中找到红色项目
3. 查看"余额趋势图"了解变化
4. 根据需要调整阈值或充值

### 4. 订阅管理

**步骤**：
1. 查看"7天内到期订阅"指标
2. 在"订阅状态详情表"中查看详情
3. 排序查看最紧急的订阅
4. 提前续费

## 🔧 自定义配置

### 修改面板

1. 编辑模式：点击面板标题 → Edit
2. 修改查询、样式、阈值等
3. 保存更改

### 导出/导入

**导出 Dashboard**：
```
Settings → JSON Model → Copy to Clipboard
```

**导入 Dashboard**：
```
Dashboards → Import → Paste JSON
```

### 共享 Dashboard

**创建快照**：
```
Share → Snapshot → Create
```

**生成链接**：
```
Share → Link → Copy Link
```

## 📱 移动端查看

Dashboard 支持响应式布局，在手机和平板上也能正常查看。

**建议**：
- 使用 Grafana App（iOS/Android）
- 横屏查看获得最佳体验

## 🆘 故障排查

### 面板显示 "No Data"

**原因**：
1. Prometheus 未采集数据
2. 时间范围内无数据
3. 查询语句错误

**解决**：
1. 检查 Prometheus Targets 状态
2. 调整时间范围
3. 检查 Metrics 端点：`http://localhost:9100/metrics`

### 数据不更新

**原因**：
1. 自动刷新已关闭
2. 余额刷新间隔未到
3. 服务异常

**解决**：
1. 启用自动刷新
2. 等待下一次刷新（默认 1 小时）
3. 检查容器日志

### 变量筛选器无选项

**原因**：
- Prometheus 中无对应标签数据

**解决**：
1. 确认项目/订阅已配置
2. 手动刷新一次余额
3. 等待 Prometheus 采集

## 📚 相关资源

- [Prometheus 文档](https://prometheus.io/docs/)
- [Grafana 文档](https://grafana.com/docs/)
- [PromQL 查询指南](https://prometheus.io/docs/prometheus/latest/querying/basics/)
- [Grafana 面板配置](https://grafana.com/docs/grafana/latest/panels/)

---

**Dashboard 版本**: 2.0
**最后更新**: 2024-02-24
**维护者**: 项目团队
